<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PermitTime – Live permit wait times</title>
  <meta name="description" content="Real-time permit issuance timelines by city. Auto-updated from official open-data portals." />
  <style>
    :root { --fg:#111; --muted:#666; --line:#e5e5e5; --bg:#fff; }
    html, body { height: 100%; }
    body { margin: 0; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--fg); background: var(--bg); }
    header { padding: 20px; border-bottom: 1px solid var(--line); display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 18px; margin: 0; }
    .city-select { font: inherit; padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; }
    main { max-width: 1000px; margin: 24px auto; padding: 0 20px 60px; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 4px; font-size: 28px; }
    .card .label { color: var(--muted); font-size: 12px; }
    h3 { margin: 28px 0 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--line); text-align: left; }
    th { background: #fafafa; }
    footer { color: var(--muted); font-size: 12px; border-top: 1px solid var(--line); padding: 16px 20px; }
    .pill { display:inline-block; background:#f6f6f6; border:1px solid var(--line); padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px }
    .hint { color: var(--muted); font-size: 12px; }
    .note { color: var(--muted); font-size: 12px; margin-top: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>PermitTime</h1>
    <select class="city-select" id="city"></select>
    <span class="hint">Auto-updated daily from official open data. Not for permitting advice.</span>
  </header>

  <main>
    <div class="kpis">
      <div class="card">
        <h2 id="median">—</h2>
        <div class="label">Median days to issue (last 30 days)</div>
        <div id="median-note" class="note"></div>
      </div>
      <div class="card">
        <h2 id="issued7">—</h2>
        <div class="label">Permits issued (last 7 days)</div>
      </div>
      <div class="card">
        <h2 id="today">—</h2>
        <div class="label">Issued today</div>
      </div>
    </div>

    <h3>By permit type (last 30 days)</h3>
    <table>
      <thead><tr><th>Type</th><th id="type-metric-h">Median days</th><th>Count</th></tr></thead>
      <tbody id="types"></tbody>
    </table>

    <h3>Methodology</h3>
    <p>
      We compute the difference between <span class="pill">application date</span> and <span class="pill">issue date</span> for permits issued in the last 30 days. Rows with missing or invalid dates are ignored. If a city’s dataset lacks application dates, we show counts and per-type activity but omit the median.
    </p>
  </main>

  <footer>
    Data is provided as-is from municipal open-data portals. Always check the official city site for definitive status.
  </footer>

  <script>
    // Configure cities. Field names are best guesses; we auto-detect real keys.
    const CITIES = {
      dallas: {
        name: "Dallas, TX",
        portal: "https://www.dallasopendata.com/resource/",
        dataset: "e7gq-4sah.json",
        fields: { applied: "application_date", issued: "issued_date", type: "permit_type" }
      }
    };

    function getCitySlug(){
      const path = location.pathname.replace(/^\/+/, "").split("/")[0];
      const qp = new URLSearchParams(location.search).get("city");
      return (path && CITIES[path]) ? path : (qp && CITIES[qp]) ? qp : "dallas";
    }

    function buildCityPicker(){
      const sel = document.getElementById('city');
      sel.innerHTML = Object.entries(CITIES).map(([slug,c]) => `<option value="${slug}">${c.name}</option>`).join('');
      sel.value = getCitySlug();
      sel.addEventListener('change', () => { history.pushState({}, '', '/' + sel.value); load(); });
    }

    // Proxy via Vercel serverless (api/soql.js)
    async function soql(portal, dataset, params){
      const q = new URLSearchParams({
        portal, dataset,
        select: params["$select"],
        where:  params["$where"],
        limit:  params["$limit"] || 50000,
        order:  params["$order"] || ""
      });
      const r = await fetch(`/api/soql?${q.toString()}`);
      if(!r.ok){
        const t = await r.text();
        throw new Error(t || `Fetch failed (${r.status})`);
      }
      return r.json();
    }

    // Auto-detect field names from a sample row (cities love renaming columns)
    async function detectFields(cfg){
      const sample = await soql(cfg.portal, cfg.dataset, { "$limit": 1 });
      const keys = Object.keys(sample[0] || {});
      const find = list => list.find(k => keys.includes(k));
      const applied = find(["application_date","applied_date","filed_date","received_date","submit_date","application_dt"]);
      const issued  = find(["issued_date","issue_date","date_issued","issueddate","issue_dt"]);
      const type    = find(["permit_type","work_type","permitclass","permit_class","permit_description","work_description"]);
      // Prefer configured values when they exist
      return {
        applied: cfg.fields.applied && keys.includes(cfg.fields.applied) ? cfg.fields.applied : applied,
        issued:  cfg.fields.issued  && keys.includes(cfg.fields.issued)  ? cfg.fields.issued  : issued,
        type:    cfg.fields.type    && keys.includes(cfg.fields.type)    ? cfg.fields.type    : type
      };
    }

    function parseDate(v){
      if(!v) return NaN;
      const d = new Date(v);
      if(!isNaN(d)) return d;
      // handle MM/DD/YY
      const m = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/.exec(v);
      if(m){
        let y = parseInt(m[3],10); if(y < 100) y += 2000;
        return new Date(y, parseInt(m[1],10)-1, parseInt(m[2],10));
      }
      return new Date(NaN);
    }

    function median(nums){
      if(!nums.length) return null;
      nums.sort((a,b)=>a-b);
      return nums[Math.floor(nums.length/2)];
    }

    async function load(){
      const slug = getCitySlug();
      const cfg = CITIES[slug];
      document.title = `PermitTime – ${cfg.name}`;

      const f = await detectFields(cfg);
      const hasApplied = !!f.applied;
      const medianNote = document.getElementById("median-note");

      // Pull a big batch and do date math locally (datasets often store dates as text)
      const fieldsWanted = [f.issued, f.type, f.applied].filter(Boolean).join(", ");
      const rows = await soql(cfg.portal, cfg.dataset, { "$select": fieldsWanted, "$limit": 50000 });

      // Prep rows: parse issued/app dates
      const now = new Date();
      const dayMs = 86400000;
      const last30 = [];
      for(const r of rows){
        const di = parseDate(r[f.issued]);
        if(!isFinite(di)) continue;
        const daysAgo = (now - di)/dayMs;
        if(daysAgo >= 0 && daysAgo <= 30) {
          const da = hasApplied ? parseDate(r[f.applied]) : NaN;
          last30.push({ issued: di, applied: da, type: (f.type && r[f.type]) || "Other" });
        }
      }

      // KPIs: counts
      const todayISO = now.toISOString().slice(0,10);
      const issued7 = last30.filter(x => (now - x.issued)/dayMs <= 7).length;
      const today = last30.filter(x => x.issued.toISOString().slice(0,10) === todayISO).length;
      document.getElementById("issued7").textContent = String(issued7);
      document.getElementById("today").textContent = String(today);

      // KPI: median days to issue (only if we have application dates)
      if(hasApplied){
        const diffs = last30
          .map(x => (x.issued - x.applied)/dayMs)
          .filter(x => isFinite(x) && x >= 0);
        const m = median(diffs);
        document.getElementById("median").textContent = m != null ? m.toFixed(1) : "—";
        medianNote.textContent = "";
        document.getElementById("type-metric-h").textContent = "Median days";
      } else {
        document.getElementById("median").textContent = "N/A";
        medianNote.textContent = "This city’s dataset doesn’t include application dates, so we show activity only.";
        document.getElementById("type-metric-h").textContent = "—";
      }

      // Table: by permit type
      const byType = {};
      for(const x of last30){
        (byType[x.type] ||= []).push(x);
      }
      const rowsOut = Object.entries(byType).map(([t,arr])=>{
        let med = "—";
        if(hasApplied){
          const diffs = arr.map(x => (x.issued - x.applied)/dayMs).filter(x => isFinite(x) && x >= 0);
          const m = median(diffs);
          med = m != null ? m.toFixed(1) : "—";
        }
        return { t, med, n: arr.length };
      }).sort((a,b)=>b.n-a.n).slice(0,16);

      document.getElementById("types").innerHTML = rowsOut.length
        ? rowsOut.map(r=>`<tr><td>${r.t}</td><td>${r.med}</td><td>${r.n}</td></tr>`).join("")
        : `<tr><td colspan="3">No permit rows in the last 30 days.</td></tr>`;
    }

    buildCityPicker();
    load().catch(err => {
      console.error(err);
      document.getElementById('median').textContent = '—';
      document.getElementById('issued7').textContent = '—';
      document.getElementById('today').textContent  = '—';
      document.getElementById('types').innerHTML = `<tr><td colspan="3">Could not load data. Try again later.</td></tr>`;
    });
  </script>
</body>
</html>
