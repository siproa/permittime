<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PermitTime – Live permit wait times</title>
  <meta name="description" content="Real-time permit issuance timelines by city. Auto-updated from official open-data portals." />
  <style>
    :root { --fg:#111; --muted:#666; --line:#e5e5e5; --bg:#fff; }
    html, body { height: 100%; }
    body { margin: 0; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--fg); background: var(--bg); }
    header { padding: 20px; border-bottom: 1px solid var(--line); display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 18px; margin: 0; }
    .city-select { font: inherit; padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; }
    main { max-width: 1000px; margin: 24px auto; padding: 0 20px 60px; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 4px; font-size: 28px; }
    .card .label { color: var(--muted); font-size: 12px; }
    h3 { margin: 28px 0 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--line); text-align: left; }
    th { background: #fafafa; }
    footer { color: var(--muted); font-size: 12px; border-top: 1px solid var(--line); padding: 16px 20px; }
    .pill { display:inline-block; background:#f6f6f6; border:1px solid var(--line); padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px }
    .hint { color: var(--muted); font-size: 12px; }
  </style>
</head>
<body>
  <header>
    <h1>PermitTime</h1>
    <select class="city-select" id="city"></select>
    <span class="hint">Auto-updated daily from official open data. Not for permitting advice.</span>
  </header>

  <main>
    <div class="kpis">
      <div class="card">
        <h2 id="median">—</h2>
        <div class="label">Median days to issue (last 30 days)</div>
      </div>
      <div class="card">
        <h2 id="issued7">—</h2>
        <div class="label">Permits issued (last 7 days)</div>
      </div>
      <div class="card">
        <h2 id="today">—</h2>
        <div class="label">Issued today</div>
      </div>
    </div>

    <h3>By permit type (last 30 days)</h3>
    <table>
      <thead><tr><th>Type</th><th>Median days</th><th>Count</th></tr></thead>
      <tbody id="types"></tbody>
    </table>

    <h3>Methodology</h3>
    <p>
      We compute the difference between <span class="pill">application date</span> and <span class="pill">issue date</span> for permits issued in the last 30 days. Rows with missing or invalid dates are ignored.
    </p>
  </main>

  <footer>
    Data is provided as-is from municipal open-data portals. Always check the official city site for definitive status.
  </footer>

  <script>
    // City configs. If fields are missing or wrong, we auto-detect them.
    const CITIES = {
      dallas: {
        name: "Dallas, TX",
        portal: "https://www.dallasopendata.com/resource/",
        dataset: "e7gq-4sah.json",
        // Guesses; auto-detect will correct these if needed.
        fields: { applied: "application_date", issued: "issue_date", type: "permit_type" }
      }
    };

    function getCitySlug(){
      const path = location.pathname.replace(/^\/+/, "").split("/")[0];
      const qp = new URLSearchParams(location.search).get("city");
      return (path && CITIES[path]) ? path : (qp && CITIES[qp]) ? qp : "dallas";
    }

    function buildCityPicker(){
      const sel = document.getElementById('city');
      sel.innerHTML = Object.entries(CITIES).map(([slug,c]) => `<option value="${slug}">${c.name}</option>`).join('');
      sel.value = getCitySlug();
      sel.addEventListener('change', () => { history.pushState({}, '', '/' + sel.value); load(); });
    }

    // Proxy via Vercel serverless (api/soql.js)
    async function soql(portal, dataset, params){
      const q = new URLSearchParams({
        portal, dataset,
        select: params["$select"],
        where:  params["$where"],
        limit:  params["$limit"] || 50000
      });
      const r = await fetch(`/api/soql?${q.toString()}`);
      if(!r.ok){
        const t = await r.text();
        throw new Error(t || `Fetch failed (${r.status})`);
      }
      return r.json();
    }

    // Try to infer field names from a sample row if our guesses are wrong.
    async function detectFields(cfg){
      const sample = await soql(cfg.portal, cfg.dataset, { "$limit": 1 });
      const keys = Object.keys(sample[0] || {});
      const find = list => list.find(k => keys.includes(k));

      const applied =
        cfg.fields?.applied ||
        find(["application_date","applied_date","filed_date","received_date","submit_date","application_dt"]);

      const issued =
        cfg.fields?.issued ||
        find(["issue_date","issued_date","date_issued","issueddate","issue_dt"]);

      const type =
        cfg.fields?.type ||
        find(["permit_type","work_type","permitclass","permit_class","permit_description","work_description","permit_description"]);

      return { applied, issued, type };
    }

    function parseDate(v){
      if(!v) return NaN;
      const d = new Date(v);
      if(!isNaN(d)) return d;
      const m = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/.exec(v);
      if(m){
        let y = parseInt(m[3],10); if(y < 100) y += 2000;
        return new Date(y, parseInt(m[1],10)-1, parseInt(m[2],10));
      }
      return new Date(NaN);
    }

    async function load(){
      const slug = getCitySlug();
      const cfg = CITIES[slug];
      document.title = `PermitTime – ${cfg.name}`;

      // Resolve real field names
      const f = await detectFields(cfg);
      if(!f.applied || !f.issued){
        document.getElementById('types').innerHTML = `<tr><td colspan="3">Dataset missing required date fields.</td></tr>`;
        return;
      }

      // KPI 1: Median days to issue (last 30 days)
      const rows = await soql(cfg.portal, cfg.dataset, {
        "$select": `${f.applied}, ${f.issued}`,
        "$where": `${f.issued} >= dateadd('day',-30, now()) AND ${f.applied} IS NOT NULL AND ${f.issued} IS NOT NULL`,
        "$limit": 50000
      });
      const diffs = rows
        .map(r => (parseDate(r[f.issued]) - parseDate(r[f.applied]))/86400000)
        .filter(x => isFinite(x) && x >= 0)
        .sort((a,b)=>a-b);
      document.getElementById('median').textContent = diffs.length ? diffs[Math.floor(diffs.length/2)].toFixed(1) : '—';

      // KPI 2/3: counts
      const todayISO = new Date().toISOString().slice(0,10);
      const last7 = await soql(cfg.portal, cfg.dataset, {
        "$select": "count(1) as c",
        "$where": `${f.issued} >= dateadd('day',-7, now())`
      });
      const today = await soql(cfg.portal, cfg.dataset, {
        "$select": "count(1) as c",
        "$where": `${f.issued} >= '${todayISO}T00:00:00' AND ${f.issued} < dateadd('day',1,'${todayISO}T00:00:00')`
      });
      document.getElementById('issued7').textContent = last7[0]?.c || '0';
      document.getElementById('today').textContent = today[0]?.c || '0';

      // Table: by permit type median
      const rows2 = await soql(cfg.portal, cfg.dataset, {
        "$select": `${f.type || "permit_type"}, ${f.applied}, ${f.issued}`,
        "$where": `${f.issued} >= dateadd('day',-30, now()) AND ${f.applied} IS NOT NULL AND ${f.issued} IS NOT NULL`,
        "$limit": 50000
      });
      const groups = {};
      for(const r of rows2){
        const t = (f.type ? r[f.type] : r["permit_type"]) || 'Other';
        const d = (parseDate(r[f.issued]) - parseDate(r[f.applied]))/86400000;
        if(!(d >= 0) || !isFinite(d)) continue;
        (groups[t] ||= []).push(d);
      }
      const out = Object.entries(groups).map(([t,arr]) => {
        arr.sort((a,b)=>a-b);
        const med = arr[Math.floor(arr.length/2)] || 0;
        return { t, med: med.toFixed(1), n: arr.length };
      }).sort((a,b)=>b.n-a.n).slice(0, 16);

      document.getElementById('types').innerHTML = out.length
        ? out.map(r => `<tr><td>${r.t}</td><td>${r.med}</td><td>${r.n}</td></tr>`).join('')
        : `<tr><td colspan="3">No data in the last 30 days.</td></tr>`;
    }

    buildCityPicker();
    load().catch(err => {
      console.error(err);
      document.getElementById('median').textContent = '—';
      document.getElementById('issued7').textContent = '—';
      document.getElementById('today').textContent  = '—';
      document.getElementById('types').innerHTML = `<tr><td colspan="3">Could not load data. Try again later.</td></tr>`;
    });
  </script>
</body>
</html>
