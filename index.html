<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PermitTime – Live permit activity by city</title>
  <meta name="description" content="Daily permit activity by city. Counts, medians (where available), top contractors, and recent permits with type, address, value, and contractor." />
  <style>
    :root { --fg:#111; --muted:#666; --line:#e5e5e5; --bg:#fff; }
    html, body { height: 100%; }
    body { margin: 0; font: 14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--fg); background: var(--bg); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--line); display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 18px; margin: 0; }
    .city-select { font: inherit; padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; }
    main { max-width: 1100px; margin: 24px auto; padding: 0 20px 60px; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
    .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 4px; font-size: 32px; }
    .card .label { color: var(--muted); font-size: 12px; }
    .note { color: var(--muted); font-size: 12px; margin-top: 6px; }
    h3 { margin: 28px 0 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--line); text-align: left; vertical-align: top;}
    th { background: #fafafa; position: sticky; top: 0; z-index: 1;}
    .toolbar { display:flex; gap:10px; align-items:center; margin: 6px 0 12px; flex-wrap: wrap;}
    .input { padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; min-width: 240px;}
    .btn { padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; background: #f8f8f8; cursor: pointer; }
    .pill { display:inline-block; background:#f6f6f6; border:1px solid var(--line); padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px }
    footer { color: var(--muted); font-size: 12px; border-top: 1px solid var(--line); padding: 16px 20px; }
    .muted { color: var(--muted); }
    .nowrap { white-space: nowrap; }
    .link { color:#0b62ff; cursor:pointer; text-decoration:underline; }
  </style>
</head>
<body>
  <header>
    <h1>PermitTime</h1>
    <select class="city-select" id="city"></select>
    <span class="muted">Auto-updated daily from official open data. Not for permitting advice.</span>
  </header>

  <main>
    <div class="kpis">
      <div class="card">
        <h2 id="median">—</h2>
        <div class="label">Median days to issue (last 30 days)</div>
        <div id="median-note" class="note"></div>
      </div>
      <div class="card">
        <h2 id="issued7">—</h2>
        <div class="label">Permits issued (last 7 days)</div>
      </div>
      <div class="card">
        <h2 id="today">—</h2>
        <div class="label">Issued today</div>
      </div>
      <div class="card">
        <h2 id="last-updated">—</h2>
        <div class="label">Last updated (local)</div>
        <div class="note">Source: <a id="dataset-link" href="#" target="_blank" rel="noopener">official dataset</a></div>
      </div>
    </div>

    <h3>By permit type (last 30 days)</h3>
    <table>
      <thead><tr><th>Type</th><th id="type-metric-h">Median days</th><th>Count</th></tr></thead>
      <tbody id="types"></tbody>
    </table>

    <h3 style="margin-top:28px">Top contractors (last 30 days)</h3>
    <div class="toolbar">
      <span class="muted">Click a contractor to filter recent permits and get a shareable URL.</span>
    </div>
    <div style="max-height:360px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
      <table>
        <thead>
          <tr>
            <th>Contractor</th>
            <th class="nowrap">Permits</th>
            <th class="nowrap">Total value</th>
            <th class="nowrap">Avg value</th>
          </tr>
        </thead>
        <tbody id="contractors"></tbody>
      </table>
    </div>

    <h3 style="margin-top:28px">Recent permits (last 7 days)</h3>
    <div class="toolbar">
      <input id="filter" class="input" placeholder="Filter by type, address, contractor, description…" />
      <button id="download" class="btn">Download CSV</button>
      <span id="rowcount" class="muted"></span>
    </div>
    <div style="max-height:520px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
      <table>
        <thead>
          <tr>
            <th class="nowrap">Issued</th>
            <th>Type</th>
            <th>Address</th>
            <th class="nowrap">Value</th>
            <th>Contractor</th>
            <th>Description</th>
          </tr>
        </thead>
        <tbody id="recent"></tbody>
      </table>
    </div>

    <h3>Methodology</h3>
    <p>
      We compute the difference between <span class="pill">application date</span> and <span class="pill">issue date</span> for permits issued in the last 30 days.
      Where application dates aren’t published, we show counts, leaderboards and recent permits but omit the median.
    </p>
  </main>

  <footer>
    Data is provided as-is from municipal open-data portals. Always check the official city site for definitive status.
  </footer>

  <script>
    // Cities. Austin is active; Dallas is stale but left in the list.
    const CITIES = {
      austin: { name: "Austin, TX", portal: "https://data.austintexas.gov/resource/", dataset: "3syk-w9eu.json" },
      dallas: { name: "Dallas, TX", portal: "https://www.dallasopendata.com/resource/", dataset: "e7gq-4sah.json" }
    };

    function getCitySlug(){
      const path = location.pathname.replace(/^\/+/, "").split("/")[0];
      const qp = new URLSearchParams(location.search).get("city");
      return (path && CITIES[path]) ? path : (qp && CITIES[qp]) ? qp : "austin";
    }
    function buildCityPicker(){
      const sel = document.getElementById('city');
      sel.innerHTML = Object.entries(CITIES).map(([slug,c]) => `<option value="${slug}">${c.name}</option>`).join('');
      sel.value = getCitySlug();
      sel.addEventListener('change', () => { history.pushState({}, '', '/' + sel.value); load(); });
    }

    // Proxy via Vercel serverless (api/soql.js)
    async function soql(portal, dataset, params){
      const clean = {};
      if (params["$select"]) clean.select = params["$select"];
      if (params["$where"])  clean.where  = params["$where"];
      if (params["$order"])  clean.order  = params["$order"];
      clean.limit = params["$limit"] || 20000;
      const q = new URLSearchParams({ portal, dataset, ...clean });
      const r = await fetch(`/api/soql?${q.toString()}`);
      const text = await r.text();
      let json = null;
      try { json = JSON.parse(text); } catch {}
      if(!r.ok || !Array.isArray(json)) throw new Error(json?.message || `Fetch failed (${r.status})`);
      return json;
    }

    async function detectFields(cfg){
      const sample = await soql(cfg.portal, cfg.dataset, { "$limit": 1 });
      const keys = Object.keys(sample[0] || {});
      const has = k => keys.includes(k);
      const find = list => list.find(has);

      return {
        issued:  find(["issued_date","issue_date","date_issued","issueddate","issue_dt","issued"]),
        applied: find(["application_date","applied_date","filed_date","received_date","submit_date","application_dt","applicationdate"]),
        type:    find(["permit_type","work_type","permitclass","permit_class","classdesc","class_desc","description","type","category","permit_description","work_description"]),
        address: find(["street_address","address","address_full","site_address","property_address","location","streetaddress"]),
        contractor: find(["contractor","contractor_name","applicant","builder","licensee","company_name","business_name"]),
        value:   find(["value","job_value","project_value","valuation","totaljobvalue","estimated_value","estimated_cost"]),
        desc:    find(["work_description","description","scope","remarks","project_description","desc"])
      };
    }

    const dayMs = 86400000;
    function parseDate(v){
      if(!v) return NaN;
      const d = new Date(v);
      if(!isNaN(d)) return d;
      const m = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/.exec(v);
      if(m){ let y = +m[3]; if(y<100) y += 2000; return new Date(y, +m[1]-1, +m[2]); }
      return new Date(NaN);
    }
    const fmtDate = d => d instanceof Date ? d.toISOString().slice(0,10) : "";
    const esc = s => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'}[c]));
    const money = n => { const x = Number(String(n).replace(/[^0-9.-]/g,"")); return isFinite(x) ? x.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}) : ""; };
    const median = a => { if(!a.length) return null; const b=[...a].sort((x,y)=>x-y); return b[Math.floor(b.length/2)]; };

    async function load(){
      const slug = getCitySlug();
      const cfg = CITIES[slug];
      document.title = `PermitTime – ${cfg.name}`;
      document.getElementById("last-updated").textContent = new Date().toLocaleString();

      // dataset link
      const datasetId = cfg.dataset.replace(".json","");
      const ds = cfg.portal.replace("/resource/","/d/") + datasetId;
      document.getElementById("dataset-link").href = ds;

      const f = await detectFields(cfg);
      if(!f.issued) throw new Error("Dataset missing issued date field");

      // fetch recent rows ordered by issued desc
      const fieldsWanted = [f.issued,f.type,f.applied,f.address,f.contractor,f.value,f.desc].filter(Boolean).join(", ");
      const rows = await soql(cfg.portal, cfg.dataset, { "$select": fieldsWanted, "$order": `${f.issued} DESC`, "$limit": 20000 });

      const now = new Date();
      const last30 = [], last7 = [];
      for(const r of rows){
        const di = parseDate(r[f.issued]);
        if(!isFinite(di)) continue;
        const entry = {
          issued: di,
          applied: f.applied ? parseDate(r[f.applied]) : NaN,
          type: (f.type && r[f.type]) || "Other",
          address: f.address ? r[f.address] : "",
          contractor: f.contractor ? String(r[f.contractor]).trim() : "",
          value: f.value ? r[f.value] : "",
          desc: f.desc ? r[f.desc] : ""
        };
        const days = (now - di)/dayMs;
        if(days >= 0 && days <= 30) last30.push(entry);
        if(days >= 0 && days <= 7)  last7.push(entry);
      }

      // KPIs
      document.getElementById("issued7").textContent = String(last7.length);
      const todayISO = now.toISOString().slice(0,10);
      document.getElementById("today").textContent = String(last7.filter(x => fmtDate(x.issued) === todayISO).length);

      // Median if possible
      if(f.applied){
        const diffs = last30.map(x => (x.issued - x.applied)/dayMs).filter(x => isFinite(x) && x >= 0);
        const m = median(diffs);
        document.getElementById("median").textContent = m != null ? m.toFixed(1) : "—";
        document.getElementById("type-metric-h").textContent = "Median days";
        document.getElementById("median-note").textContent = "";
      } else {
        document.getElementById("median").textContent = "N/A";
        document.getElementById("type-metric-h").textContent = "—";
        document.getElementById("median-note").textContent = "This dataset lacks application dates; showing activity and leaderboards only.";
      }

      // By type (30 days)
      const byType = {};
      for(const x of last30){ (byType[x.type] ||= []).push(x); }
      const typeRows = Object.entries(byType).map(([t,arr])=>{
        let med = "—";
        if(f.applied){
          const d = arr.map(x => (x.issued - x.applied)/dayMs).filter(x => isFinite(x) && x >= 0);
          const m = median(d); med = m != null ? m.toFixed(1) : "—";
        }
        return { t, med, n: arr.length };
      }).sort((a,b)=>b.n-a.n).slice(0,16);
      document.getElementById("types").innerHTML = typeRows.length
        ? typeRows.map(r=>`<tr><td>${esc(r.t)}</td><td>${r.med}</td><td>${r.n}</td></tr>`).join("")
        : `<tr><td colspan="3">No permit rows in the last 30 days.</td></tr>`;

      // Top contractors (30 days)
      const byCtr = {};
      for(const x of last30){
        const key = x.contractor || "(Unspecified)";
        const val = Number(String(x.value).replace(/[^0-9.-]/g,""));
        if(!byCtr[key]) byCtr[key] = { n:0, sum:0 };
        byCtr[key].n += 1;
        if(isFinite(val)) byCtr[key].sum += val;
      }
      const ctrRows = Object.entries(byCtr)
        .filter(([name]) => name && name !== "(Unspecified)")
        .map(([name,stats]) => ({ name, n: stats.n, sum: stats.sum, avg: stats.n ? stats.sum/stats.n : 0 }))
        .sort((a,b)=> b.n - a.n || b.sum - a.sum)
        .slice(0, 25);

      const ctrTbody = document.getElementById("contractors");
      const setContractorParam = (name) => {
        const url = new URL(location.href);
        url.searchParams.set("contractor", name);
        history.replaceState({}, "", url.toString());
      };
      ctrTbody.innerHTML = ctrRows.length
        ? ctrRows.map(r => `
            <tr>
              <td><span class="link" data-ctr="${esc(r.name)}">${esc(r.name)}</span></td>
              <td class="nowrap">${r.n}</td>
              <td class="nowrap">${money(r.sum)}</td>
              <td class="nowrap">${money(r.avg)}</td>
            </tr>
          `).join("")
        : `<tr><td colspan="4">No contractor activity in the last 30 days.</td></tr>`;

      // Recent permits (7 days) + filter + CSV + contractor deep-link
      let shown = [...last7].sort((a,b)=>b.issued - a.issued);
      const tbody = document.getElementById("recent");
      const counter = document.getElementById("rowcount");
      const render = () => {
        counter.textContent = shown.length ? `${shown.length} rows` : "No rows match.";
        tbody.innerHTML = shown.map(r=>`
          <tr>
            <td class="nowrap">${fmtDate(r.issued)}</td>
            <td>${esc(r.type)}</td>
            <td>${esc(r.address || "")}</td>
            <td class="nowrap">${money(r.value)}</td>
            <td>${esc(r.contractor || "")}</td>
            <td>${esc(String(r.desc || "").slice(0,140))}${String(r.desc||"").length>140?"…":""}</td>
          </tr>
        `).join("");
      };

      const applyFilter = (q) => {
        const needle = q.toLowerCase();
        shown = last7.filter(r =>
          [r.type, r.address, r.contractor, r.desc].some(v => String(v||"").toLowerCase().includes(needle))
        ).sort((a,b)=>b.issued - a.issued);
        render();
      };

      // wire search box
      const filterBox = document.getElementById("filter");
      filterBox.addEventListener("input", e => applyFilter(e.target.value));

      // wire contractor click -> filter + URL param
      ctrTbody.querySelectorAll("[data-ctr]").forEach(el => {
        el.addEventListener("click", () => {
          const name = el.getAttribute("data-ctr");
          filterBox.value = name;
          setContractorParam(name);
          applyFilter(name);
          // Scroll to recent table
          document.getElementById("recent").closest("div").scrollIntoView({ behavior: "smooth", block: "start" });
        });
      });

      // deep-link: ?contractor=...
      const initCtr = new URLSearchParams(location.search).get("contractor");
      if(initCtr){
        filterBox.value = initCtr;
        applyFilter(initCtr);
      } else {
        render();
      }

      // CSV download
      document.getElementById("download").onclick = ()=>{
        const rows = shown.map(r=>[
          fmtDate(r.issued),
          r.type || "",
          (r.address || "").replace(/,/g," "),
          String(r.value || ""),
          (r.contractor || "").replace(/,/g," "),
          (String(r.desc||"").replace(/\s+/g," ").replace(/,/g," "))
        ]);
        const header = ["issued","type","address","value","contractor","description"];
        const csv = [header, ...rows].map(a=>a.join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `${slug}-recent-permits.csv`; a.click();
        URL.revokeObjectURL(url);
      };
    }

    buildCityPicker();
    load().catch(err => {
      console.error(err);
      document.getElementById('median').textContent = '—';
      document.getElementById('issued7').textContent = '—';
      document.getElementById('today').textContent  = '—';
      document.getElementById('types').innerHTML = `<tr><td colspan="3">Could not load data. Try again later.</td></tr>`;
      document.getElementById('contractors').innerHTML = `<tr><td colspan="4">Could not load data. Try again later.</td></tr>`;
      document.getElementById('recent').innerHTML = `<tr><td colspan="6">Could not load data. Try again later.</td></tr>`;
    });
  </script>
</body>
</html>
