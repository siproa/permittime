<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PermitTime – Live permit wait times</title>
  <meta name="description" content="Real-time permit issuance timelines by city. Auto-updated from official open-data portals." />
  <style>
    :root { --fg:#111; --muted:#666; --line:#e5e5e5; --bg:#fff; }
    html, body { height: 100%; }
    body { margin: 0; font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; color: var(--fg); background: var(--bg); }
    header { padding: 20px; border-bottom: 1px solid var(--line); display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 18px; margin: 0; }
    .city-select { font: inherit; padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; }
    main { max-width: 1000px; margin: 24px auto; padding: 0 20px 60px; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; }
    .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 4px; font-size: 28px; }
    .card .label { color: var(--muted); font-size: 12px; }
    h3 { margin: 28px 0 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--line); text-align: left; }
    th { background: #fafafa; }
    footer { color: var(--muted); font-size: 12px; border-top: 1px solid var(--line); padding: 16px 20px; }
    .pill { display:inline-block; background:#f6f6f6; border:1px solid var(--line); padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px }
    .hint { color: var(--muted); font-size: 12px; }
    .note { color: var(--muted); font-size: 12px; margin-top: 6px; }
  </style>
</head>
<body>
  <header>
    <h1>PermitTime</h1>
    <select class="city-select" id="city"></select>
    <span class="hint">Auto-updated daily from official open data. Not for permitting advice.</span>
  </header>

  <main>
    <div class="kpis">
      <div class="card">
        <h2 id="median">—</h2>
        <div class="label">Median days to issue (last 30 days)</div>
        <div id="median-note" class="note"></div>
      </div>
      <div class="card">
        <h2 id="issued7">—</h2>
        <div class="label">Permits issued (last 7 days)</div>
      </div>
      <div class="card">
        <h2 id="today">—</h2>
        <div class="label">Issued today</div>
      </div>
    </div>

    <h3>By permit type (last 30 days)</h3>
    <table>
      <thead><tr><th>Type</th><th id="type-metric-h">Median days</th><th>Count</th></tr></thead>
      <tbody id="types"></tbody>
    </table>

    <h3>Methodology</h3>
    <p>
      We compute the difference between <span class="pill">application date</span> and <span class="pill">issue date</span> for permits issued in the last 30 days. Rows with missing or invalid dates are ignored. If a city’s dataset lacks application dates, we show counts and per-type activity but omit the median.
    </p>
  </main>

  <footer>
    Data is provided as-is from municipal open-data portals. Always check the official city site for definitive status.
  </footer>

  <script>
    // City configs. We’ll auto-detect actual field names from a sample row.
    const CITIES = {
      dallas: {
        name: "Dallas, TX",
        portal: "https://www.dallasopendata.com/resource/",
        dataset: "e7gq-4sah.json",
        fields: { applied: null, issued: "issued_date", type: "permit_type" } // Dallas has issued_date; app date often missing
      }
    };

    function getCitySlug(){
      const path = location.pathname.replace(/^\/+/, "").split("/")[0];
      const qp = new URLSearchParams(location.search).get("city");
      return (path && CITIES[path]) ? path : (qp && CITIES[qp]) ? qp : "dallas";
    }

    function buildCityPicker(){
      const sel = document.getElementById('city');
      sel.innerHTML = Object.entries(CITIES).map(([slug,c]) => `<option value="${slug}">${c.name}</option>`).join('');
      sel.value = getCitySlug();
      sel.addEventListener('change', () => { history.pushState({}, '', '/' + sel.value); load(); });
    }

    // Proxy via Vercel serverless (api/soql.js)
    async function soql(portal, dataset, params){
      const clean = {};
      if (params["$select"]) clean.select = params["$select"];
      if (params["$where"])  clean.where  = params["$where"];
      if (params["$order"])  clean.order  = params["$order"];
      clean.limit = params["$limit"] || 20000; // cap for sanity
      const q = new URLSearchParams({ portal, dataset, ...clean });
      const r = await fetch(`/api/soql?${q.toString()}`);
      const text = await r.text();
      let json = null;
      try { json = JSON.parse(text); } catch { /* fall through */ }
      if(!r.ok || !Array.isArray(json)) {
        throw new Error(json?.message || `Fetch failed (${r.status})`);
      }
      return json;
    }

    // Auto-detect field names from a sample row (cities rename for sport)
    async function detectFields(cfg){
      const sample = await soql(cfg.portal, cfg.dataset, { "$limit": 1 });
      const keys = Object.keys(sample[0] || {});
      const find = list => list.find(k => keys.includes(k));
      const applied = cfg.fields.applied || find(["application_date","applied_date","filed_date","received_date","submit_date","application_dt"]);
      const issued  = cfg.fields.issued  && keys.includes(cfg.fields.issued) ? cfg.fields.issued
                      : find(["issued_date","issue_date","date_issued","issueddate","issue_dt"]);
      const type    = cfg.fields.type    && keys.includes(cfg.fields.type)   ? cfg.fields.type
                      : find(["permit_type","work_type","permitclass","permit_class","permit_description","work_description"]);
      return { applied, issued, type };
    }

    function parseDate(v){
      if(!v) return NaN;
      const d = new Date(v);
      if(!isNaN(d)) return d;
      const m = /^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/.exec(v);
      if(m){
        let y = parseInt(m[3],10); if(y < 100) y += 2000;
        return new Date(y, parseInt(m[1],10)-1, parseInt(m[2],10));
      }
      return new Date(NaN);
    }

    function median(nums){
      if(!nums.length) return null;
      nums.sort((a,b)=>a-b);
      return nums[Math.floor(nums.length/2)];
    }

    async function load(){
      const slug = getCitySlug();
      const cfg = CITIES[slug];
      document.title = `PermitTime – ${cfg.name}`;
      const medianNote = document.getElementById("median-note");

      // Resolve fields
      const f = await detectFields(cfg);
      if(!f.issued){
        throw new Error("Dataset missing issued date field");
      }

      // Pull a large recent slice, ordered by issued date (string sort is fine for MM/DD/YY)
      const fieldsWanted = [f.issued, f.type, f.applied].filter(Boolean).join(", ");
      const rows = await soql(cfg.portal, cfg.dataset, {
        "$select": fieldsWanted,
        "$order":  `${f.issued} DESC`,
        "$limit":  20000
      });

      // Normalize and keep only last 30 days by issued date
      const now = new Date(), dayMs = 86400000, todayISO = now.toISOString().slice(0,10);
      const last30 = [];
      for(const r of rows){
        const di = parseDate(r[f.issued]);
        if(!isFinite(di)) continue;
        if((now - di)/dayMs <= 30 && (now - di) >= 0){
          const da = f.applied ? parseDate(r[f.applied]) : NaN;
          last30.push({ issued: di, applied: da, type: (f.type && r[f.type]) || "Other" });
        }
      }

      // Counts
      const issued7 = last30.filter(x => (now - x.issued)/dayMs <= 7).length;
      const today = last30.filter(x => x.issued.toISOString().slice(0,10) === todayISO).length;
      document.getElementById("issued7").textContent = String(issued7);
      document.getElementById("today").textContent = String(today);

      // Median
      if(f.applied){
        const diffs = last30.map(x => (x.issued - x.applied)/dayMs).filter(x => isFinite(x) && x >= 0);
        const m = median(diffs);
        document.getElementById("median").textContent = m != null ? m.toFixed(1) : "—";
        document.getElementById("type-metric-h").textContent = "Median days";
        medianNote.textContent = "";
      } else {
        document.getElementById("median").textContent = "N/A";
        document.getElementById("type-metric-h").textContent = "—";
        medianNote.textContent = "This dataset lacks application dates; showing activity only.";
      }

      // Table by type
      const byType = {};
      for(const x of last30){ (byType[x.type] ||= []).push(x); }
      const rowsOut = Object.entries(byType).map(([t,arr])=>{
        let med = "—";
        if(f.applied){
          const diffs = arr.map(x => (x.issued - x.applied)/dayMs).filter(x => isFinite(x) && x >= 0);
          const m = median(diffs); med = m != null ? m.toFixed(1) : "—";
        }
        return { t, med, n: arr.length };
      }).sort((a,b)=>b.n-a.n).slice(0,16);

      document.getElementById("types").innerHTML = rowsOut.length
        ? rowsOut.map(r=>`<tr><td>${r.t}</td><td>${r.med}</td><td>${r.n}</td></tr>`).join("")
        : `<tr><td colspan="3">No permit rows in the last 30 days.</td></tr>`;
    }

    buildCityPicker();
    load().catch(err => {
      console.error(err);
      document.getElementById('median').textContent = '—';
      document.getElementById('issued7').textContent = '—';
      document.getElementById('today').textContent  = '—';
      document.getElementById('types').innerHTML = `<tr><td colspan="3">Could not load data. Try again later.</td></tr>`;
    });
  </script>
</body>
</html>
