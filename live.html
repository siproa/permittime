<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PermitTime – Live permit activity by city</title>
  <style>
    :root { --fg:#111; --muted:#666; --line:#e5e5e5; --bg:#fff; --warn:#b00020; --warnbg:#ffe8ec; }
    body { margin:0; font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color:var(--fg); background:var(--bg); }
    header { padding:16px 20px; border-bottom:1px solid var(--line); display:flex; gap:16px; align-items:center; flex-wrap:wrap; }
    header h1 { font-size:18px; margin:0; }
    .city-select { font:inherit; padding:8px 10px; border:1px solid var(--line); border-radius:8px; min-width:160px; }
    main { max-width:1100px; margin:24px auto; padding:0 20px 60px; }
    .kpis { display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:16px; }
    .card { border:1px solid var(--line); border-radius:12px; padding:16px; }
    .card h2 { margin:0 0 4px; font-size:32px; }
    .label { color:var(--muted); font-size:12px; }
    .note { color:var(--muted); font-size:12px; margin-top:6px; }
    h3 { margin:28px 0 10px; }
    table { width:100%; border-collapse:collapse; }
    th,td { padding:10px 8px; border-bottom:1px solid var(--line); text-align:left; vertical-align:top; }
    th { background:#fafafa; position:sticky; top:0; z-index:1; }
    .toolbar { display:flex; gap:10px; align-items:center; margin:6px 0 12px; flex-wrap:wrap; }
    .input { padding:8px 10px; border:1px solid var(--line); border-radius:8px; min-width:240px; }
    .btn { padding:8px 10px; border:1px solid var(--line); border-radius:8px; background:#f8f8f8; cursor:pointer; }
    .pill { display:inline-block; background:#f6f6f6; border:1px solid var(--line); padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px }
    .muted { color:var(--muted); }
    .badge { font-size:11px; padding:2px 6px; border:1px solid var(--line); border-radius:999px; background:#f6f6f6; margin-left:6px; }
    .err { background:var(--warnbg); color:var(--warn); border:1px solid var(--warn); padding:10px 12px; margin:10px 20px 0; border-radius:10px; font-size:13px; display:none; white-space:pre-wrap }
    .stamp { font:11px monospace; color:#666; margin-left:auto }
  </style>
</head>
<body>
  <header>
    <h1>PermitTime</h1>
    <select id="city" class="city-select"><option value="austin">Austin, TX</option></select>
    <span class="muted">Auto-updated daily from official open data. Not for permitting advice.</span>
    <span id="build-stamp" class="stamp"></span>
  </header>

  <div id="errbox" class="err"></div>

  <main>
    <div class="kpis">
      <div class="card">
        <h2 id="median">—</h2>
        <div class="label">Median days to issue (last <span id="window-label-1">30</span> days)</div>
        <div id="median-note" class="note"></div>
      </div>
      <div class="card">
        <h2 id="issued7">—</h2>
        <div class="label">Permits issued (last 7 days)</div>
      </div>
      <div class="card">
        <h2 id="today">—</h2>
        <div class="label">Issued today</div>
      </div>
      <div class="card">
        <h2 id="last-updated">—</h2>
        <div class="label">
          Last updated (local)
          <span id="fallback-badge" class="badge" style="display:none">showing 90 days</span>
        </div>
        <div class="note">Source: <a id="dataset-link" href="#" target="_blank" rel="noopener">official dataset</a></div>
      </div>
    </div>

    <h3>By permit type (last <span id="window-label-2">30</span> days)</h3>
    <table>
      <thead><tr><th>Type</th><th id="type-metric-h">Median days</th><th>Count</th></tr></thead>
      <tbody id="types"></tbody>
    </table>

    <h3 style="margin-top:28px">Top contractors (last <span id="window-label-3">30</span> days)</h3>
    <div class="toolbar"><span class="muted">Click a contractor to filter recent permits and get a shareable URL.</span></div>
    <div style="max-height:360px;overflow:auto;border:1px solid var(--line);border-radius:12px;">
      <table>
        <thead><tr><th>Contractor</th><th>Permits</th><th>Total value</th><th>Avg value</th></tr></thead>
        <tbody id="contractors"></tbody>
      </table>
    </div>

    <h3 style="margin-top:28px">Recent permits (last 7 days)</h3>
    <div class="toolbar">
      <input id="filter" class="input" placeholder="Filter by type, address, contractor, description…"/>
      <button id="download" class="btn">Download CSV</button>
      <span id="rowcount" class="muted"></span>
    </div>
    <div style="max-height:520px;overflow:auto;border:1px solid var(--line);border-radius:12px;">
      <table>
        <thead><tr><th>Issued</th><th>Type</th><th>Address</th><th>Value</th><th>Contractor</th><th>Description</th></tr></thead>
        <tbody id="recent"></tbody>
      </table>
    </div>

    <h3>Methodology</h3>
    <p>We compute the difference between <span class="pill">application date</span> and <span class="pill">issue date</span> for permits issued in the last 30 days. Where application dates aren’t published, we show counts, leaderboards and recent permits but omit the median.</p>
  </main>

  <footer class="muted" style="border-top:1px solid var(--line); padding:16px 20px;">
    Data is provided as-is from municipal open-data portals. Always check the official city site for definitive status.
  </footer>

<script>
  // ---------- helpers ----------
  const esc = s => String(s ?? '').replace(/[&<>"/'`]/g, c =>
    ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'}[c]));
  const money = n => isFinite(+n) ? (+n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}) : '';
  const fmtDate = d => new Date(d).toISOString().slice(0,10);
  const isoDay = (offsetDays=0) => fmtDate(new Date(Date.now() + offsetDays*86400000));
  const buildStamp = () => (document.getElementById('build-stamp')||{}).textContent =
      'build ' + new Date().toLocaleString();

  // ---------- city config (Austin) ----------
const c = {
  name: 'Austin, TX',
  portal: 'https://data.austintexas.gov',
  dataset: '3syk-w9eu.json',
  f: {
    // the dataset's column names
    issued: 'issue_date',            // <-- was wrong or pointing at completed_date
    applied: null,                   // Austin doesn’t publish application date
    type: 'permit_type_desc',
    address: 'permit_location',
    contractor: 'contractor',
    value: 'value',
    desc: 'work_description'         // fallback to 'description' if you prefer
  }
};

  // ---------- tiny SOQL fetch via our proxy ----------
  async function soql(params){
    const p = new URLSearchParams(params);
    const url = `/api/soql?portal=${encodeURIComponent(C.portal)}&dataset=${encodeURIComponent(C.dataset)}&${p}`;
    const r = await fetch(url, { headers:{'Accept':'application/json'} });
    const t = await r.text();
    let j=null; try{ j=JSON.parse(t); }catch{}
    if (!r.ok || !Array.isArray(j)) throw new Error(`SOQL ${r.status}: ${t.slice(0,180)}`);
    return j;
  }

  // ---------- main ----------
  (async function run(){
    buildStamp();

    // dates
    const today    = isoDay(0);
    const tomorrow = isoDay(1);
    const start7   = isoDay(-7);
    const start30  = isoDay(-30);

    // set page title and dataset link
    document.title = `PermitTime – ${C.name}`;
    const ds = document.getElementById('dataset-link');
    if (ds) ds.href = C.portal.replace(/\/?$/,'/') + C.dataset.replace('.json','');

    // 1) KPIs
  // Helpers to build "YYYY-MM-DDT00:00:00" in UTC so it's stable
const isoDateOnly = d => new Date(Date.UTC(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate()))
  .toISOString().slice(0,19); // "YYYY-MM-DDTHH:MM:SS"

const today = new Date();
const startToday = isoDateOnly(today);
const tomorrow = new Date(today); tomorrow.setUTCDate(tomorrow.getUTCDate() + 1);
const startTomorrow = isoDateOnly(tomorrow);

const sevenDaysAgo = new Date(today); sevenDaysAgo.setUTCDate(sevenDaysAgo.getUTCDate() - 7);
const start7 = isoDateOnly(sevenDaysAgo);

const thirtyDaysAgo = new Date(today); thirtyDaysAgo.setUTCDate(thirtyDaysAgo.getUTCDate() - 30);
const start30 = isoDateOnly(thirtyDaysAgo);

// 7-day issued count
const last7 = await soql({
  $select: 'count(1) as c',
  $where: `${c.f.issued} >= '${start7}' AND ${c.f.issued} < '${startTomorrow}'`,
  $limit: 1
});
document.getElementById('issued7').textContent = last7?.[0]?.c ?? '0';

// today issued count
const todayQ = await soql({
  $select: 'count(1) as c',
  $where: `${c.f.issued} >= '${startToday}' AND ${c.f.issued} < '${startTomorrow}'`,
  $limit: 1
});
document.getElementById('today').textContent = todayQ?.[0]?.c ?? '0';

// by type in last 30 days (no median if applied is missing)
const byTypeRows = await soql({
  $select: `${c.f.type} as t, count(1) as n`,
  $where: `${c.f.issued} >= '${start30}' AND ${c.f.issued} < '${startTomorrow}'`,
  $group: c.f.type,
  $order: 'n DESC',
  $limit: 200
});
document.getElementById('types').innerHTML = byTypeRows.length
  ? byTypeRows.map(r => `<tr><td>${r.t || 'Other'}</td><td>—</td><td>${r.n}</td></tr>`).join('')
  : `<tr><td colspan="3">No permit rows in the last 30 days.</td></tr>`;

    // 2) Pull last 30 days rows once
    let rows30 = [];
    try {
      rows30 = await soql({
        "$select": [
          C.f.applied, C.f.issued, C.f.type, C.f.address,
          "contractor","value","work_description","description"
        ].filter(Boolean).join(', '),
        "$where": `${C.f.issued} >= '${start30}T00:00:00'`,
        "$order": `${C.f.issued} DESC`,
        "$limit": 50000
      });
    } catch(e) {
      console.error('rows30 error:', e);
    }

    // 3) Median
    try {
      if (C.f.applied) {
        const diffs = rows30.map(r => {
          const a = new Date(r[C.f.applied]);
          const i = new Date(r[C.f.issued]);
          const d = (i - a)/86400000;
          return isFinite(d) && d >= 0 ? d : null;
        }).filter(x => x!=null).sort((a,b)=>a-b);
        const med = diffs.length ? diffs[Math.floor(diffs.length/2)].toFixed(1) : '—';
        document.querySelector('#median h2').textContent = diffs.length ? med : '—';
      } else {
        document.querySelector('#median h2').textContent = 'N/A';
        document.getElementById('median-note')?.classList.remove('hidden');
      }
    } catch(e) {
      console.error('median error:', e);
    }

    // 4) By type (counts + median where possible)
    try {
      const groups = {};
      for (const r of rows30) {
        const t = r[C.f.type] || 'Other';
        (groups[t] ||= []).push(r);
      }
      const out = Object.entries(groups).map(([t,arr])=>{
        let med = '—';
        if (C.f.applied) {
          const ds = arr.map(r=>{
            const a=new Date(r[C.f.applied]), i=new Date(r[C.f.issued]);
            const d=(i-a)/86400000; return isFinite(d)&&d>=0?d:null;
          }).filter(x=>x!=null).sort((a,b)=>a-b);
          if (ds.length) med = ds[Math.floor(ds.length/2)].toFixed(1);
        }
        return { t, med, n: arr.length };
      }).sort((a,b)=>b.n-a.n);
      const tbody = document.getElementById('types');
      if (tbody) tbody.innerHTML = out.map(r=>`<tr><td>${esc(r.t)}</td><td>${r.med}</td><td>${r.n}</td></tr>`).join('');
    } catch(e) {
      console.error('types error:', e);
    }

    // 5) Top contractors
    try {
      const byCtr = {};
      for (const r of rows30) {
        const name = String(r.contractor||'').trim();
        if (!name) continue;
        byCtr[name] = byCtr[name] || { n:0, sum:0, avg:0 };
        byCtr[name].n++;
        const val = +r.value;
        if (isFinite(val)) byCtr[name].sum += val;
      }
      for (const k in byCtr) byCtr[k].avg = byCtr[k].n ? byCtr[k].sum/byCtr[k].n : 0;
      const top = Object.entries(byCtr).sort((a,b)=>b[1].n-a[1].n).slice(0,25);
      const body = document.getElementById('contractors');
      if (body) body.innerHTML = top.map(([name,s]) =>
        `<tr><td>${esc(name)}</td><td>${s.n}</td><td>${money(s.sum)}</td><td>${money(s.avg)}</td></tr>`).join('')
        || `<tr><td colspan="4">No contractor activity in the selected window.</td></tr>`;
    } catch(e) {
      console.error('contractors error:', e);
    }

    // 6) Recent (last 7 days)
    try {
      const recent = rows30.filter(r => new Date(r[C.f.issued]) >= new Date(start7+'T00:00:00'))
        .map(r=>({
          issued: r[C.f.issued],
          type:   r[C.f.type] || 'Other',
          address: r[C.f.address] || '',
          value:   money(r.value),
          contractor: r.contractor || '',
          desc: r.work_description || r.description || ''
        }))
        .sort((a,b)=> new Date(b.issued) - new Date(a.issued));

      const tbody = document.getElementById('recent');
      if (tbody) {
        tbody.innerHTML = recent.length
          ? recent.map(r=>`<tr>
              <td>${fmtDate(r.issued)}</td>
              <td>${esc(r.type)}</td>
              <td>${esc(r.address)}</td>
              <td>${esc(r.value)}</td>
              <td>${esc(r.contractor)}</td>
              <td>${esc(String(r.desc).slice(0,120))}</td>
            </tr>`).join('')
          : `<tr><td colspan="6">No permits in the last 7 days.</td></tr>`;
      }

      // filter + CSV
      document.getElementById('filter')?.addEventListener('input', e=>{
        const q = e.target.value.toLowerCase();
        const shown = recent.filter(r =>
          [r.type,r.address,r.contractor,r.desc].some(v=>String(v).toLowerCase().includes(q)));
        tbody.innerHTML = shown.map(r=>`<tr>
          <td>${fmtDate(r.issued)}</td>
          <td>${esc(r.type)}</td>
          <td>${esc(r.address)}</td>
          <td>${esc(r.value)}</td>
          <td>${esc(r.contractor)}</td>
          <td>${esc(String(r.desc).slice(0,120))}</td>
        </tr>`).join('') || `<tr><td colspan="6">No matching rows.</td></tr>`;
      });

      document.getElementById('download')?.addEventListener('click', ()=>{
        const rows = recent.map(r=>[fmtDate(r.issued), r.type, r.address, r.value, r.contractor, r.desc.replace(/[\r\n,]+/g,' ')]);
        const csv = [['Issued','Type','Address','Value','Contractor','Description']]
          .concat(rows).map(a=>a.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv],{type:'text/csv'}), a=document.createElement('a');
        a.href = URL.createObjectURL(blob); a.download = 'austin-recent-permits.csv'; a.click();
        URL.revokeObjectURL(a.href);
      });
    } catch(e) {
      console.error('recent error:', e);
    }
  })();
</script>

</body>
</html>
