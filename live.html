<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PermitTime – Live permit activity by city</title>
<style>
:root{--fg:#111;--muted:#666;--line:#e5e5e5;--bg:#fff;--chip:#f6f6f6}
html,body{height:100%}
body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:var(--bg)}
header{display:flex;gap:12px;align-items:center;flex-wrap:wrap;padding:16px 20px;border-bottom:1px solid var(--line)}
h1{font-size:18px;margin:0}
select{font:inherit;padding:8px 10px;border:1px solid var(--line);border-radius:8px}
main{max-width:1100px;margin:24px auto;padding:0 20px 70px}
.kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{border:1px solid var(--line);border-radius:12px;padding:16px}
.card h2{margin:0 0 4px;font-size:28px}
.card .label{color:var(--muted);font-size:12px}
h3{margin:28px 0 10px}
table{width:100%;border-collapse:collapse}
th,td{padding:10px 8px;border-bottom:1px solid var(--line);text-align:left}
th{background:#fafafa}
.badge{display:inline-block;background:var(--chip);border:1px solid var(--line);padding:2px 8px;border-radius:999px;font-size:12px}
.muted{color:var(--muted);font-size:12px}
#erbox{display:none;border:1px solid var(--line);padding:12px;border-radius:8px;white-space:pre-wrap;font:12px ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;color:#b00020;background:#fff8f8;margin-bottom:16px}
</style>
</head>
<body>
<header>
  <h1>PermitTime</h1>
  <select id="city"></select>
  <span class="muted">Auto-updated daily from official open data. Not for permitting advice.</span>
  <span id="stamp" class="muted" style="margin-left:auto"></span>
</header>

<main>
  <div id="erbox"></div>

  <div class="kpis">
    <div class="card">
      <h2 id="median">—</h2>
      <div class="label" id="median-label">Median days to issue (last 30 days)</div>
    </div>
    <div class="card">
      <h2 id="issued7">—</h2>
      <div class="label">Permits issued (last 7 days)</div>
    </div>
    <div class="card">
      <h2 id="today">—</h2>
      <div class="label">Issued today</div>
    </div>
    <div class="card">
      <h2 id="last-updated">—</h2>
      <div class="label">Last updated (local)<div class="muted">Source: <a id="dataset-link" href="#" target="_blank" rel="noopener">official dataset</a></div></div>
    </div>
  </div>

  <h3>By permit type (last 30 days)</h3>
  <table>
    <thead><tr><th>Type</th><th>Median days</th><th>Count</th></tr></thead>
    <tbody id="types"><tr><td colspan="3" class="muted">Loading…</td></tr></tbody>
  </table>

  <h3>Top contractors (last 30 days)</h3>
  <div class="muted" style="margin:-4px 0 8px">Click a contractor to filter recent permits and get a shareable URL.</div>
  <table>
    <thead><tr><th>Contractor</th><th>Permits</th><th>Total value</th><th>Avg value</th></tr></thead>
    <tbody id="contractors"><tr><td colspan="4" class="muted">Loading…</td></tr></tbody>
  </table>

  <h3>Recent permits (last 7 days)</h3>
  <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
    <input id="filter" class="input" placeholder="Filter by type, address, contractor, description…" style="flex:1;padding:8px 10px;border:1px solid var(--line);border-radius:8px"/>
    <button id="download" style="padding:8px 12px;border:1px solid var(--line);border-radius:8px;background:#fff">Download CSV</button>
  </div>
  <div class="muted" id="rowcount"> </div>
  <table>
    <thead><tr>
      <th>Issued</th><th>Type</th><th>Address</th><th>Value</th><th>Contractor</th><th>Description</th>
    </tr></thead>
    <tbody id="recent"><tr><td colspan="6" class="muted">Loading…</td></tr></tbody>
  </table>

  <h3>Methodology</h3>
  <p class="muted">
    We compute the difference between <span class="badge">application date</span> and <span class="badge">issue date</span> for permits issued in the last 30 days. 
    Where application dates aren’t published, we show counts, leaderboards and recent permits but omit the median.
  </p>
</main>

<script>
/** City config (Austin has no application date field; median will show N/A) */
const CITIES = {
  austin: {
    name: "Austin, TX",
    portal: "https://data.austintexas.gov/resource/",
    dataset: "3syk-w9eu.json",
    fields: {
      issued: "issue_date",
      applied: null, // <- no application date in this dataset
      type: "permit_type_desc",
      value: "value",
      contractor: "contractor",
      address: "permit_location",
      desc: "description"
    },
    datasetPage: "https://data.austintexas.gov/Permitting/Permits/3syk-w9eu"
  }
};

const esc = s => String(s??"").replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]);
const money = n => isFinite(+n) ? (+n).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0}) : '';

function isoDay(d){ // YYYY-MM-DD
  const y=d.getFullYear(), m=String(d.getMonth()+1).padStart(2,'0'), day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}
function daysAgo(n){ const d=new Date(); d.setDate(d.getDate()-n); return d; }

function getCitySlug(){
  const path=location.pathname.replace(/^\/+/,'').split('/')[0];
  const qp=new URLSearchParams(location.search).get('city');
  return (path && CITIES[path])?path:(qp && CITIES[qp])?qp:'austin';
}
function setStamp(){
  document.getElementById('stamp').textContent = 'JS OK • '+new Date().toLocaleString();
  document.getElementById('last-updated').textContent = new Date().toLocaleString();
}

async function soql(base, dataset, params){
  const q = new URLSearchParams(params).toString();
  const url = `/api/soql?portal=${encodeURIComponent(base)}&dataset=${encodeURIComponent(dataset)}&${q}`;
  const r = await fetch(url);
  if(!r.ok) throw new Error(`Fetch ${r.status} ${r.statusText}`);
  return r.json();
}

function buildCityPicker(){
  const sel=document.getElementById('city');
  sel.innerHTML = Object.entries(CITIES).map(([slug,c])=>`<option value="${slug}">${c.name}</option>`).join('');
  sel.value = getCitySlug();
  sel.addEventListener('change', ()=>{ history.pushState({},'', '/'+sel.value); load(); });
}

async function load(){
  const er = document.getElementById('erbox'); er.style.display='none'; er.textContent='';
  setStamp();

  const slug=getCitySlug();
  const cfg=CITIES[slug];
  document.title = `PermitTime – ${cfg.name}`;
  document.getElementById('dataset-link').href = cfg.datasetPage;

  const f=cfg.fields;

  // time windows (use explicit strings; SoQL has no now()/dateadd())
  const today = new Date();
  const todayISO = isoDay(today);
  const tomorrowISO = isoDay(new Date(today.getFullYear(), today.getMonth(), today.getDate()+1));
  const start7ISO = isoDay(daysAgo(7));
  const start30ISO = isoDay(daysAgo(30));

  // 7-day count
  try {
    const last7 = await soql(cfg.portal, cfg.dataset, {
      select: "count(1) as c",
      where: `${f.issued} >= '${start7ISO}T00:00:00'`
    });
    document.getElementById('issued7').textContent = last7?.[0]?.c ?? '0';
  } catch(e){ document.getElementById('issued7').textContent='—'; er.textContent+=`\n7-day: ${e.message}`; er.style.display='block'; }

  // today count
  try {
    const todayRows = await soql(cfg.portal, cfg.dataset, {
      select: "count(1) as c",
      where: `${f.issued} >= '${todayISO}T00:00:00' AND ${f.issued} < '${tomorrowISO}T00:00:00'`
    });
    document.getElementById('today').textContent = todayRows?.[0]?.c ?? '0';
  } catch(e){ document.getElementById('today').textContent='—'; er.textContent+=`\nToday: ${e.message}`; er.style.display='block'; }

  // median (only if application date exists)
  if (f.applied){
    try{
      const rows = await soql(cfg.portal, cfg.dataset, {
        select: `${f.applied}, ${f.issued}`,
        where: `${f.issued} >= '${start30ISO}T00:00:00' AND ${f.applied} IS NOT NULL AND ${f.issued} IS NOT NULL`,
        limit: 50000
      });
      const diffs = rows.map(r => (new Date(r[f.issued]) - new Date(r[f.applied]))/86400000)
                        .filter(x => isFinite(x) && x >= 0)
                        .sort((a,b)=>a-b);
      document.getElementById('median').textContent = diffs.length ? diffs[Math.floor(diffs.length/2)].toFixed(1) : '—';
      document.getElementById('median-label').textContent = 'Median days to issue (last 30 days)';
    } catch(e){ document.getElementById('median').textContent='—'; er.textContent+=`\nMedian: ${e.message}`; er.style.display='block'; }
  } else {
    document.getElementById('median').textContent = 'N/A';
    document.getElementById('median-label').innerHTML = 'This dataset lacks application dates; showing activity only.';
  }

  // by type (last 30 days) – median per type only if we have applied
  try{
    const sel = f.applied ? `${f.type}, ${f.applied}, ${f.issued}` : `${f.type}, ${f.issued}`;
    const rows = await soql(cfg.portal, cfg.dataset, {
      select: sel,
      where: `${f.issued} >= '${start30ISO}T00:00:00' AND ${f.issued} IS NOT NULL`,
      limit: 50000
    });
    const byType = {};
    for(const r of rows){
      const t = r[f.type] || 'Other';
      (byType[t] ||= []).push(r);
    }
    const out = Object.entries(byType).map(([t,arr])=>{
      const n = arr.length;
      let med = '—';
      if(f.applied){
        const diffs = arr.map(r => (new Date(r[f.issued]) - new Date(r[f.applied]))/86400000)
                         .filter(x => isFinite(x) && x >= 0)
                         .sort((a,b)=>a-b);
        med = diffs.length ? diffs[Math.floor(diffs.length/2)].toFixed(1) : '—';
      }
      return {t, med, n};
    }).sort((a,b)=>b.n-a.n);
    document.getElementById('types').innerHTML = out.length
      ? out.map(r=>`<tr><td>${esc(r.t)}</td><td>${r.med}</td><td>${r.n}</td></tr>`).join('')
      : `<tr><td colspan="3" class="muted">No permit rows in the last 30 days.</td></tr>`;
  }catch(e){ document.getElementById('types').innerHTML = `<tr><td colspan="3">Could not load data.</td></tr>`; er.textContent+=`\nTypes: ${e.message}`; er.style.display='block'; }

  // top contractors (last 30 days)
  try{
    const rows = await soql(cfg.portal, cfg.dataset, {
      select: `${f.contractor}, ${f.value}`,
      where: `${f.issued} >= '${start30ISO}T00:00:00'`,
      limit: 50000
    });
    const ag = {};
    for(const r of rows){
      const name = String(r[f.contractor]||'').trim() || '(Unspecified)';
      const val = +r[f.value];
      (ag[name] ||= {n:0,sum:0}).n++;
      if(isFinite(val)) ag[name].sum += val;
    }
    const list = Object.entries(ag).map(([name,{n,sum}])=>({name,n,sum,avg: n? (sum/n):0}))
                  .sort((a,b)=>b.n-a.n || b.sum-a.sum).slice(0,25);
    document.getElementById('contractors').innerHTML = list.length
      ? list.map(r=>`<tr><td>${esc(r.name)}</td><td>${r.n}</td><td>${money(r.sum)}</td><td>${money(r.avg)}</td></tr>`).join('')
      : `<tr><td colspan="4" class="muted">No contractor activity in the selected window.</td></tr>`;
  }catch(e){ document.getElementById('contractors').innerHTML = `<tr><td colspan="4">Could not load data.</td></tr>`; er.textContent+=`\nContractors: ${e.message}`; er.style.display='block'; }

  // recent (last 7 days), filter & CSV
  try{
    const fields = `${f.issued}, ${f.type}, ${f.address}, ${f.value}, ${f.contractor}, ${f.desc}`;
    const rows = await soql(cfg.portal, cfg.dataset, {
      select: fields,
      where: `${f.issued} >= '${start7ISO}T00:00:00'`,
      limit: 5000
    });
    const tbody = document.getElementById('recent');
    const counter = document.getElementById('rowcount');

    const shown = rows.map(r=>({
      issued: r[f.issued],
      type: r[f.type] || 'Other',
      address: r[f.address] || '',
      value: r[f.value],
      contractor: r[f.contractor] || '',
      desc: r[f.desc] || ''
    })).sort((a,b)=>new Date(b.issued)-new Date(a.issued));

    function fmtdate(x){ try{ return new Date(x).toLocaleDateString(); }catch{ return x||''; } }

    function render(filter=''){
      const needle = filter.toLowerCase();
      const vis = needle ? shown.filter(r =>
        [r.type,r.address,r.contractor,r.desc].some(v=>String(v).toLowerCase().includes(needle))
      ) : shown;

      counter.textContent = vis.length ? `${vis.length} row(s) in the last 7 days.` : 'No permits in the last 7 days.';
      tbody.innerHTML = vis.map(r=>`<tr>
        <td>${fmtdate(r.issued)}</td><td>${esc(r.type)}</td><td>${esc(r.address)}</td>
        <td>${money(r.value)}</td><td>${esc(r.contractor)}</td><td>${esc(r.desc)}</td>
      </tr>`).join('') || `<tr><td colspan="6" class="muted">No permits in the last 7 days.</td></tr>`;
    }
    render();

    document.getElementById('filter').addEventListener('input', e=>render(e.target.value));

    document.getElementById('download').addEventListener('click', ()=>{
      const rowsOut = shown.map(r=>({
        issued: r.issued, type: r.type, address: r.address, value: r.value, contractor: r.contractor, description: r.desc
      }));
      const header = ['issued','type','address','value','contractor','description'];
      const csv = [header.join(','), ...rowsOut.map(r=>header.map(k=>String(r[k]??'').replace(/"/g,'""')).map(s=>`"${s}"`).join(','))].join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='recent-permits.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

  }catch(e){
    document.getElementById('recent').innerHTML = `<tr><td colspan="6">Could not load recent permits.</td></tr>`;
    document.getElementById('rowcount').textContent='';
    const er = document.getElementById('erbox'); er.textContent+=`\nRecent: ${e.message}`; er.style.display='block';
  }
}

buildCityPicker();
load().catch(e=>{ const b=document.getElementById('erbox'); b.textContent = e.stack||String(e); b.style.display='block'; });
</script>
</body>
</html>
