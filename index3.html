<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PermitTime – Live permit activity by city</title>
  <meta name="description" content="Daily permit activity by city. Counts, medians (where available), top contractors, and recent permits with type, address, value, and contractor." />
  <style>
    :root { --fg:#111; --muted:#666; --line:#e5e5e5; --bg:#fff; --warn:#b00020; --warnbg:#ffe8ec; }
    html, body { height: 100%; }
    body { margin: 0; font: 14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif; color: var(--fg); background: var(--bg); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--line); display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    header h1 { font-size: 18px; margin: 0; }
    .city-select { font: inherit; padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; min-width: 160px; }
    main { max-width: 1100px; margin: 24px auto; padding: 0 20px 60px; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 16px; }
    .card { border: 1px solid var(--line); border-radius: 12px; padding: 16px; }
    .card h2 { margin: 0 0 4px; font-size: 32px; }
    .card .label { color: var(--muted); font-size: 12px; }
    .note { color: var(--muted); font-size: 12px; margin-top: 6px; }
    h3 { margin: 28px 0 10px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 8px; border-bottom: 1px solid var(--line); text-align: left; vertical-align: top; }
    th { background:#fafafa; position: sticky; top: 0; z-index: 1; }
    .toolbar { display:flex; gap:10px; align-items:center; margin:6px 0 12px; flex-wrap:wrap; }
    .input { padding: 8px 10px; border: 1px solid var(--line); border-radius: 8px; min-width: 240px; }
    .btn { padding: 8px 10px; border:1px solid var(--line); border-radius:8px; background:#f8f8f8; cursor:pointer; }
    .pill { display:inline-block; background:#f6f6f6; border:1px solid var(--line); padding:2px 8px; border-radius:999px; font-size:12px; margin-right:6px }
    .muted { color:var(--muted); }
    .nowrap { white-space:nowrap; }
    .link { color:#0b62ff; cursor:pointer; text-decoration:underline; }
    .err { background: var(--warnbg); color: var(--warn); border:1px solid var(--warn); padding:10px 12px; margin:10px 20px 0; border-radius:10px; font-size:13px; display:none; }
    .badge { font-size:11px; padding:2px 6px; border:1px solid var(--line); border-radius:999px; background:#f6f6f6; margin-left:6px; }
  </style>
</head>
<body>
  <header>
    <h1>PermitTime</h1>
    <select id="city" class="city-select">
      <option value="austin">Austin, TX</option>
      <option value="dallas">Dallas, TX</option>
    </select>
    <span class="muted">Auto-updated daily from official open data. Not for permitting advice.</span>
  </header>

  <div id="errbox" class="err"></div>

  <main>
    <div class="kpis">
      <div class="card">
        <h2 id="median">—</h2>
        <div class="label">Median days to issue (last <span id="window-label-1">30</span> days)</div>
        <div id="median-note" class="note"></div>
      </div>
      <div class="card">
        <h2 id="issued7">—</h2>
        <div class="label">Permits issued (last 7 days)</div>
      </div>
      <div class="card">
        <h2 id="today">—</h2>
        <div class="label">Issued today</div>
      </div>
      <div class="card">
        <h2 id="last-updated">—</h2>
        <div class="label">Last updated (local) <span id="fallback-badge" class="badge" style="display:none">showing 90 days</span></div>
        <div class="note">Source: <a id="dataset-link" href="#" target="_blank" rel="noopener">official dataset</a></div>
      </div>
    </div>

    <h3>By permit type (last <span id="window-label-2">30</span> days)</h3>
    <table>
      <thead><tr><th>Type</th><th id="type-metric-h">Median days</th><th>Count</th></tr></thead>
      <tbody id="types"></tbody>
    </table>

    <h3 style="margin-top:28px">Top contractors (last <span id="window-label-3">30</span> days)</h3>
    <div class="toolbar"><span class="muted">Click a contractor to filter recent permits and get a shareable URL.</span></div>
    <div style="max-height:360px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
      <table>
        <thead><tr><th>Contractor</th><th class="nowrap">Permits</th><th class="nowrap">Total value</th><th class="nowrap">Avg value</th></tr></thead>
        <tbody id="contractors"></tbody>
      </table>
    </div>

    <h3 style="margin-top:28px">Recent permits (last 7 days)</h3>
    <div class="toolbar">
      <input id="filter" class="input" placeholder="Filter by type, address, contractor, description…" />
      <button id="download" class="btn">Download CSV</button>
      <span id="rowcount" class="muted"></span>
    </div>
    <div style="max-height:520px; overflow:auto; border:1px solid var(--line); border-radius:12px;">
      <table>
        <thead>
          <tr><th class="nowrap">Issued</th><th>Type</th><th>Address</th><th class="nowrap">Value</th><th>Contractor</th><th>Description</th></tr>
        </thead>
        <tbody id="recent"></tbody>
      </table>
    </div>

    <h3>Methodology</h3>
    <p>
      We compute the difference between <span class="pill">application date</span> and <span class="pill">issue date</span> for permits issued in the last 30 days.
      Where application dates aren’t published, we show counts, leaderboards and recent permits but omit the median.
    </p>
  </main>

  <footer class="muted" style="border-top:1px solid var(--line); padding:16px 20px;">
    Data is provided as-is from municipal open-data portals. Always check the official city site for definitive status.
  </footer>

  <script>
    function fatal(msg){ console.error(msg); const b=document.getElementById('errbox'); b.textContent='Error: '+msg; b.style.display='block'; }
    window.addEventListener('error', e => fatal(e.message));

    // Cities config
    const CITIES = {
      austin: {
        name: "Austin, TX",
        portal: "https://data.austintexas.gov/resource/",
        dataset: "3syk-w9eu.json",
        fields: { issued:"completed_date", applied:"applicationdate", type:"permit_type_desc", address:"permit_location" }
      },
      dallas: {
        name: "Dallas, TX",
        portal: "https://www.dallasopendata.com/resource/",
        dataset: "e7gq-4sah.json",
        fields: { issued:"issued_date", type:"permit_type", applied:"application_date", address:"street_address" }
      }
    };

    // utils
    const dayMs = 86400000;
    const fmtDate = d => d instanceof Date ? d.toISOString().slice(0,10) : "";
    const money = n => { const x = Number(String(n).replace(/[^0-9.-]/g,"")); return isFinite(x) ? x.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0}) : ""; };
    const esc = s => String(s ?? "").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;'}[c]));
    const median = a => { if(!a.length) return null; const b=[...a].sort((x,y)=>x-y); return b[Math.floor(b.length/2)]; };

    function getCitySlug(){
      const path = location.pathname.replace(/^\/+/, "").split("/")[0];
      const qp = new URLSearchParams(location.search).get("city");
      return (path && CITIES[path]) ? path : (qp && CITIES[qp]) ? qp : "austin";
    }
    function buildCityPicker(){
      const sel = document.getElementById('city');
      sel.innerHTML = Object.entries(CITIES).map(([slug,c]) => `<option value="${slug}">${c.name}</option>`).join('');
      sel.value = getCitySlug();
      sel.addEventListener('change', () => { history.pushState({}, '', '/' + sel.value); safeLoad(); });
    }

    // Socrata proxy (serverless). Accepts select/where/order/limit
    async function soql(portal, dataset, params){
      const clean = {};
      if (params["$select"]) clean.select = params["$select"];
      if (params["$where"])  clean.where  = params["$where"];
      if (params["$order"])  clean.order  = params["$order"];
      if (params["$group"])  clean.group  = params["$group"];
      clean.limit = params["$limit"] || 20000;
      const q = new URLSearchParams({ portal, dataset, ...clean });
      const r = await fetch(`/api/soql?${q.toString()}`);
      const txt = await r.text();
      let json; try { json = JSON.parse(txt); } catch {}
      if(!r.ok || !Array.isArray(json)) throw new Error((json && json.message) || `Fetch failed (${r.status})`);
      return json;
    }

    async function load(){
      const slug = getCitySlug();
      const cfg = CITIES[slug];
      const f = cfg.fields || {};

      document.title = `PermitTime – ${cfg.name}`;
      document.getElementById('last-updated').textContent = new Date().toLocaleString();

      // dataset link
      const datasetId = cfg.dataset.replace(".json","");
      document.getElementById("dataset-link").href = cfg.portal.replace("/resource/","/d/") + datasetId;
      document.getElementById("fallback-badge").style.display = "none";
      document.getElementById("window-label-1").textContent = "30";
      document.getElementById("window-label-2").textContent = "30";
      document.getElementById("window-label-3").textContent = "30";

      // WHEREs
      const todayISO = new Date().toISOString().slice(0,10);
      const where30 = `${f.issued} >= dateadd('day',-30, now())`;
      const where90 = `${f.issued} >= dateadd('day',-90, now())`;
      const where7  = `${f.issued} >= dateadd('day',-7, now())`;
      const whereToday = `${f.issued} >= '${todayISO}T00:00:00' AND ${f.issued} < dateadd('day',1,'${todayISO}T00:00:00')`;

      // columns (safe)
      const fieldsWanted = [f.issued,f.type,f.applied,f.address,"contractor","value","work_description","description"].filter(Boolean).join(", ");

      // 30, else 90 with badge
      let rows30 = await soql(cfg.portal, cfg.dataset, { "$select": fieldsWanted, "$where": where30, "$order": `${f.issued} DESC`, "$limit": 50000 });
      if(rows30.length === 0){
        rows30 = await soql(cfg.portal, cfg.dataset, { "$select": fieldsWanted, "$where": where90, "$order": `${f.issued} DESC`, "$limit": 50000 });
        document.getElementById("fallback-badge").style.display = "inline-block";
        document.getElementById("window-label-1").textContent = "90";
        document.getElementById("window-label-2").textContent = "90";
        document.getElementById("window-label-3").textContent = "90";
      }

      // counts
      const last7count = await soql(cfg.portal, cfg.dataset, { "$select": "count(1) as c", "$where": where7, "$limit": 1 });
      const todaycount = await soql(cfg.portal, cfg.dataset, { "$select": "count(1) as c", "$where": whereToday, "$limit": 1 });

      document.getElementById("issued7").textContent = String(+last7count?.[0]?.c || 0);
      document.getElementById("today").textContent  = String(+todaycount?.[0]?.c || 0);

      // median
      if(f.applied){
        const diffs = rows30.map(r=>{
          const a = r[f.applied], i = r[f.issued];
          const da = a ? new Date(a) : NaN, di = i ? new Date(i) : NaN;
          return (di-da)/86400000;
        }).filter(x=>isFinite(x)&&x>=0);
        const m = diffs.length ? median(diffs) : null;
        document.getElementById("median").textContent = m!=null ? m.toFixed(1) : "—";
        document.getElementById("type-metric-h").textContent = "Median days";
        document.getElementById("median-note").textContent = "";
      } else {
        document.getElementById("median").textContent = "N/A";
        document.getElementById("type-metric-h").textContent = "—";
        document.getElementById("median-note").textContent = "This dataset lacks application dates; showing activity and leaderboards only.";
      }

      // by type
      const byType = {};
      for(const r of rows30){
        const t = r[f.type] || "Other";
        (byType[t] ||= []).push(r);
      }
      const typeRows = Object.entries(byType).map(([t,arr])=>{
        let med="—";
        if(f.applied){
          const d = arr.map(x=>{
            const a=x[f.applied], i=x[f.issued];
            const da=a?new Date(a):NaN, di=i?new Date(i):NaN;
            return (di-da)/86400000;
          }).filter(x=>isFinite(x)&&x>=0);
          const m = d.length ? median(d) : null; med = m!=null ? m.toFixed(1) : "—";
        }
        return { t, med, n: arr.length };
      }).sort((a,b)=>b.n-a.n).slice(0,16);
      document.getElementById("types").innerHTML = typeRows.length
        ? typeRows.map(r=>`<tr><td>${esc(r.t)}</td><td>${r.med}</td><td>${r.n}</td></tr>`).join("")
        : `<tr><td colspan="3">No permit rows in the selected window.</td></tr>`;

      // top contractors
      const byCtr = {};
      for(const r of rows30){
        const name = (r.contractor || "").toString().trim();
        const key = name || "(Unspecified)";
        const val = Number(String(r.value).replace(/[^0-9.-]/g,""));
        if(!byCtr[key]) byCtr[key] = { n:0, sum:0 };
        byCtr[key].n += 1;
        if(isFinite(val)) byCtr[key].sum += val;
      }
      const ctrRows = Object.entries(byCtr)
        .filter(([name])=>name && name!=="(Unspecified)")
        .map(([name,s])=>({ name, n:s.n, sum:s.sum, avg: s.n ? s.sum/s.n : 0 }))
        .sort((a,b)=> b.n - a.n || b.sum - a.sum)
        .slice(0,25);
      const ctrTbody = document.getElementById("contractors");
      ctrTbody.innerHTML = ctrRows.length
        ? ctrRows.map(r=>`<tr><td><span class="link" data-ctr="${esc(r.name)}">${esc(r.name)}</span></td><td class="nowrap">${r.n}</td><td class="nowrap">${money(r.sum)}</td><td class="nowrap">${money(r.avg)}</td></tr>`).join("")
        : `<tr><td colspan="4">No contractor activity in the selected window.</td></tr>`;

      // recent (7d)
      const fieldsRecent = [f.issued,f.type,f.address,"value","contractor","work_description","description"].filter(Boolean).join(", ");
      const recentRows = await soql(cfg.portal, cfg.dataset, { "$select": fieldsRecent, "$where": where7, "$order": `${f.issued} DESC`, "$limit": 5000 });
      let shown = recentRows.map(r=>({
        issued: r[f.issued] ? new Date(r[f.issued]) : NaN,
        type: r[f.type] || "Other",
        address: r[f.address] || "",
        value: r.value || "",
        contractor: r.contractor || "",
        desc: r.work_description || r.description || ""
      })).sort((a,b)=> b.issued - a.issued);

      const tbody = document.getElementById("recent");
      const counter = document.getElementById("rowcount");
      const render = () => {
        counter.textContent = shown.length ? `${shown.length} rows` : "No permits in the last 7 days.";
        tbody.innerHTML = shown.map(r=>`
          <tr>
            <td class="nowrap">${fmtDate(r.issued)}</td>
            <td>${esc(r.type)}</td>
            <td>${esc(r.address)}</td>
            <td class="nowrap">${money(r.value)}</td>
            <td>${esc(r.contractor)}</td>
            <td>${esc(String(r.desc).slice(0,140))}${String(r.desc).length>140?"…":""}</td>
          </tr>
        `).join("");
      };

      const filterBox = document.getElementById("filter");
      filterBox.addEventListener("input", e => {
        const q = e.target.value.toLowerCase();
        shown = recentRows.filter(x =>
          [x[f.type], x[f.address], x.contractor, (x.work_description||x.description||"")].some(v => String(v||"").toLowerCase().includes(q))
        ).map(r=>({
          issued: r[f.issued] ? new Date(r[f.issued]) : NaN,
          type: r[f.type] || "Other",
          address: r[f.address] || "",
          value: r.value || "",
          contractor: r.contractor || "",
          desc: r.work_description || r.description || ""
        })).sort((a,b)=> b.issued - a.issued);
        render();
      });

      ctrTbody.querySelectorAll("[data-ctr]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const name = el.getAttribute("data-ctr");
          filterBox.value = name;
          const url = new URL(location.href); url.searchParams.set("contractor", name); history.replaceState({}, "", url.toString());
          filterBox.dispatchEvent(new Event("input"));
          tbody.closest("div").scrollIntoView({ behavior:"smooth", block:"start" });
        });
      });

      const initCtr = new URLSearchParams(location.search).get("contractor");
      if(initCtr){ filterBox.value = initCtr; filterBox.dispatchEvent(new Event("input")); } else { render(); }

      document.getElementById("download").onclick = ()=>{
        const rows = (shown.length ? shown : []).map(r=>[
          fmtDate(r.issued), r.type, r.address.replace(/,/g," "), String(r.value||""), r.contractor.replace(/,/g," "), String(r.desc||"").replace(/\s+/g," ").replace(/,/g," ")
        ]);
        const header = ["issued","type","address","value","contractor","description"];
        const csv = [header, ...rows].map(a=>a.join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = `${slug}-recent-permits.csv`; a.click(); URL.revokeObjectURL(url);
      };
    }

    async function safeLoad(){ try{ document.getElementById('errbox').style.display='none'; await load(); } catch(e){ fatal(e.message||e); } }

    buildCityPicker();
    document.getElementById('city').value = getCitySlug();
    document.getElementById('last-updated').textContent = new Date().toLocaleString();
    safeLoad();
  </script>
</body>
</html>
